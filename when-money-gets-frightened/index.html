<!DOCTYPE html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>When Money Gets Frightened - Chris K. N.</title><meta name="description" content="Sebastian Külps swirls around in his deep desk chair and leans back, a gesture that makes him look the young, prosperous and generally hardworking man that he is. Like most of his colleagues, he is in his early thirties, male and confident. His business card&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><script defer="defer" type="gdpr-blocker/Analytics" data-domain="christian.nordtomme.com" src="https://plausible.io/js/plausible.js"></script><link rel="canonical" href="https://christian.nordtomme.com/when-money-gets-frightened/"><link rel="alternate" type="application/atom+xml" href="https://christian.nordtomme.com/feed.xml"><link rel="alternate" type="application/json" href="https://christian.nordtomme.com/feed.json"><meta property="og:title" content="When Money Gets Frightened"><meta property="og:image" content="https://christian.nordtomme.com/media/posts/11/North_face_south_tower_after_plane_strike_9-11.jpg"><meta property="og:image:width" content="717"><meta property="og:image:height" content="824"><meta property="og:site_name" content="Chris K. N."><meta property="og:description" content="Sebastian Külps swirls around in his deep desk chair and leans back, a gesture that makes him look the young, prosperous and generally hardworking man that he is. Like most of his colleagues, he is in his early thirties, male and confident. His business card&hellip;"><meta property="og:url" content="https://christian.nordtomme.com/when-money-gets-frightened/"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@nordtomme"><meta name="twitter:title" content="When Money Gets Frightened"><meta name="twitter:description" content="Sebastian Külps swirls around in his deep desk chair and leans back, a gesture that makes him look the young, prosperous and generally hardworking man that he is. Like most of his colleagues, he is in his early thirties, male and confident. His business card&hellip;"><meta name="twitter:image" content="https://christian.nordtomme.com/media/posts/11/North_face_south_tower_after_plane_strike_9-11.jpg"><link rel="stylesheet" href="https://christian.nordtomme.com/assets/css/style.css?v=4552bcf67384bb346e427f6ab62513d8"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://christian.nordtomme.com/when-money-gets-frightened/"},"headline":"When Money Gets Frightened","datePublished":"2002-03-11T04:43","dateModified":"2023-09-12T21:22","image":{"@type":"ImageObject","url":"https://christian.nordtomme.com/media/posts/11/North_face_south_tower_after_plane_strike_9-11.jpg","height":824,"width":717},"description":"Sebastian Külps swirls around in his deep desk chair and leans back, a gesture that makes him look the young, prosperous and generally hardworking man that he is. Like most of his colleagues, he is in his early thirties, male and confident. His business card&hellip;","author":{"@type":"Person","name":"Chris K. N.","url":"https://christian.nordtomme.com/authors/chris-k-n/"},"publisher":{"@type":"Organization","name":"Chris K. N."}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript></head><body><div class="site-container"><header class="top" id="js-header"><a class="logo" href="https://christian.nordtomme.com/">Chris K. N.</a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://christian.nordtomme.com/tags/norwegian/" target="_self">Innlegg på norsk</a></li><li><a href="https://christian.nordtomme.com/tags/english/" target="_self">Posts in English</a></li></ul></nav></header><main><article class="post"><div class="hero"><figure class="hero__image hero__image--overlay"><img src="https://christian.nordtomme.com/media/posts/11/North_face_south_tower_after_plane_strike_9-11.jpg" loading="eager" height="824" width="717" alt=""></figure><header class="hero__content"><div class="wrapper"><div class="post__meta"><time datetime="2002-03-11T04:43">March 11, 2002</time></div><h1>When Money Gets Frightened</h1><div class="post__meta post__meta--author"><a href="https://christian.nordtomme.com/authors/chris-k-n/" class="feed__author">Chris K. N.</a></div></div></header></div><div class="wrapper post__entry"><p></p><p>Sebastian Külps swirls around in his deep desk chair and leans back, a gesture that makes him look the young, prosperous and generally hardworking man that he is. Like most of his colleagues, he is in his early thirties, male and confident. His business card says vice president, and his clothes say relaxed, yet professional. He throws a glance at the clocks on the wall, showing the time around the world.</p><p></p><p></p><p>His local time there on the trading floor of J.P.Morgan's Frankfurt office is 14.30 and in New York the time is 8.30. In another half&nbsp;hour, Wall Street will be open for trading. The markets will then probably slide a bit lower, as they have been doing for some months now. Fairly soon the last months' rate cuts by the American and European central banks should start having an effect on the markets, but that won't happen today, nor will it happen tomorrow. There's still a little way down before the bottom is reached and the tide turns, so for the moment, it might be smart to be somewhat cautious.</p><p></p><p></p><p>It's a fairly quiet afternoon, as could be expected. He could cold-call some prospective clients, pitch some investment ideas, but it would hardly be worth it before he sees how New York performs. Sebastian is obviously not the only one having a calm day. A couple of guys are standing around a computer screen chatting; the Swede next to him is talking leisurely on the phone. He scans through the news on his Bloomberg and Reuters screens, but there's nothing much interesting enough to keep his attention. He types an instant message into his Bloomberg keyboard and sends it to his cousin, best friend and fellow equities broker Max in New York. He should be at the office about now.</p><p></p><p></p><figure class="wp-block-pullquote"><blockquote><p>In the world of finance, only those who can predict the future have a future. If there's a boom in June, all the money was already made in January.</p></blockquote></figure><p></p><p></p><p>Sebastian spins around in his chair and looks up at the clocks again. Only ten-fifteen minutes left. He turns back to the screen. Instead of a reply, a news item rolls onto the lower of the two Bloomberg screens. Apparently, a plane has crashed into the north tower of the World Trade Center a couple of minutes ago. Wow, that's pretty sad, he thinks. A guy would have to be very drunk or very crazy to fly his little plane into one of those buildings.</p><p></p><p></p><p>More news rolls in, and now Reuters has picked up the story, too. The image on the TV screens hanging from the ceiling suddenly changes from studio view to a long distance shot of a smoking World Trade Center. Somebody turns up the volume, and in a matter of seconds 70 chirping brokers, 210 keyboards, and 560 phone lines go quiet. The voice of a stunned CNN anchor dominates the room.</p><p></p><p></p><p>In the world of finance, only those who can predict the future have a future. That's the necessary consequence of the rule of thumb Sebastian outlines six months after the September 11 attacks: "Everything happens six months before the actual event." If there's a boom in June, all the money was already made in January.</p><p></p><p></p><p>But September 11 was unpredictable. In half a working day, USD 16 billion worth of property was destroyed and USD 5 billion worth of insured friends and family died. In the first moments after the attacks, everyone was in shock, until, all of a sudden and simultaneously, people around the world decided to catch up.</p><p></p><p></p><p>"We could see the markets correcting massively," Sebastian says. With a few clicks on the black keyboard, he brings up a snapshot of September 11 on the top Bloomberg screen. It's a black screen on which a sloping green line abruptly goes into a free fall. He uses the end of his pen to point out a piece of the vertical line.</p><p></p><p></p><p>"This is September 11," he says, then moves his pen lower. "And this is the twelfth, the thirteenth..."</p><p></p><p></p><p>A stone's throw from Sebastian's desk lies the Deutsche Börse, the stock exchange. A few dozen people in suits are walking around leisurely, chatting to each other, throwing glances up at the big board that Sebastian's little screen imitates in design. This calm atmosphere is quite common these days; the digital age has moved most traders and brokers to computers in nearby offices. On the fatal day, however, there were more people on the floor, more action, and a vertical line split the big, blackboard in two. By some accounts, it was "hectic." Dr. Ronald Weichert, spokesman for Deutsche Bank, doesn't quite agree.</p><p></p><p></p><p>"Hectic? When there's an earthquake or when a volcano erupts, and people know it won't happen again. That's hectic," he says. "This was total insecurity. Everyone was scrambling to close their positions, as we say; to get out of the market. People would rather take a loss and know what they have lost, than to sit on something they don't know what's happening to."</p><p></p><p></p><p>When a billion-dollar investment can turn to smoking rubble in minutes, and nothing seems to be certain, people scramble for that which they can trust. The price of gold, everybody's favorite crisis commodity, climbed almost twenty U.S. dollars in the hour and a half following the first attack, and cash was king.</p><p></p><p></p><p>When the World Trade Center collapsed, it took with it the Bank of New York, the world's largest settlement bank, and much of the infrastructure needed to move money. Millions of dollars were stopped in mid-transaction, missing in action. Tens of millions of dollars couldn't be used for the payments, purchases or paycheques for which they were intended. Hundreds of millions of dollars couldn't find their way back home. Everyone wanted cash, but there wasn't much to get a hold of.</p><p></p><p></p><figure class="wp-block-pullquote"><blockquote><p>Hectic? When there's an earthquake or when a volcano erupts, and people know it won't happen again. That's hectic. This was total insecurity.</p></blockquote></figure><p></p><p></p><p>To prevent the price of cash, the real short-term interest rate, from skyrocketing, the European Central Bank stepped in, giving out short term loans, putting liquidity back in the markets and keeping the interest rate down. Two days later, on September 13, the Federal Reserve and the ECB entered into a swap agreement, a move that ensured that Europe didn't run out of dollars and that international trade stayed on track. But with the scare Finance had taken, big money was still hesitating.</p><p></p><p></p><p>On ECB President Wim Duisenberg's desk in the shiny Frankfurt skyscraper sits a white phone. Despite its common appearance, it is not a common phone. Operating outside the normal network, it is absolutely safe against wiretapping, and with it, the central bank president can reach the members of the governing council when decisions have to be made outside of scheduled meetings, under extraordinary circumstances. This hotline stayed cool, however, when the need arose on September 17. The ECB president was in Helsinki and had to borrow his Finnish colleague's similar white phone for that day's urgent business.</p><p></p><p></p><p>That Monday, with unprecedented synchronicity, the ECB and the Fed both lowered the interest rate by half a percentage point to give the markets confidence and increase investment incentive.</p><p></p><p></p><p>"The first recovery came a couple of days later," Sebastian says. "The value players started to buy first. People were asking themselves, 'which prices have fallen too far?' I mean, some companies had dropped incredibly. Some of the airlines, for instance: Looking at the numbers you'd think they were all on the verge of bankruptcy."</p><p></p><p></p><p>"Many people were still uncertain, however," Sebastian continues to explain, "and consumption numbers were still low. But in the end, everything smoothed out. We're definitely at levels like before September 11 now. I think the market used the opportunity to find the bottom and then recover."</p><p></p><p></p><p>Does this mean that everything is back to normal in the world where normal means nine digits or more?</p><p></p><p></p><p>Among fourteenth- and fifteenth-century buildings in idyllic Zurich, the third largest financial center in the world, Citibank's local lodgings in a comparatively bland low-rise are quite low-profile and seem an unlikely target for terrorism. Managing Director Per Etholm, Citibank's man in charge in Switzerland, greets the English-deficient guard and passes through the turnstile.</p><p></p><p></p><figure class="wp-block-pullquote"><blockquote><p>Manhattan is the heart of a global environment in which you closest colleague and best friend sits half-way around the world.</p></blockquote></figure><p></p><p></p><p>Along with all the other country managers for Europe, he dealt with the unfolding events of September 11 telephonically from the thirty-fourth floor of the Warsaw Marriott Hotel, the Polish capital's tallest building.</p><p></p><p></p><p>"I organized stricter security, evacuations, extra security guards," Per says. "It's not like you can do very much about a plane coming toward you, but you can at least make sure that nobody comes through the door with a bomb."</p><p></p><p></p><p>"Please excuse the extra security," is a common greeting these days. In downtown Frankfurt am Main, for instance, otherwise called "Mainhattan" for its skyline, Deutsche Bank's Twin Towers have armed guards outside every entrance, and guarded turnstiles in front of the elevators.</p><p></p><p></p><p>A five-minute walk away, the armed guard outside the ECB's prestigious skyscraper will show visitors to the armed guard inside, who will check their identification against a list of expected visitors before sending them on to the reception desk. The same list appears, and phone calls are made before the visitor is given a badge that acts as a key to the heavily guarded, bullet-proof glass doors that protect the waiting area.</p><p></p><p></p><p>"It good for morale too," Per continues, "that employees see that the company cares about them and protects them."</p><p></p><p></p><p>There's a gloomier side to the financial world after September 11 than the all-too-visible security. Manhattan is the heart of a global environment in which you closest colleague and best friend sits half-way around the world.</p><p></p><p></p><p>On September 11, Per says, "there was a senior management teleconference going on when New York suddenly went silent. They had just witnessed the first plane hit the building." When analysts talk about "insecurity in the markets," it is the players and not the markets who are insecure.</p><p></p><p></p><p>"The people we had evacuated from [World Trade Center] no. 7," Per goes on to describe, "had to run to avoid getting hit by falling people and concrete." Is it strange that some employees feel uncomfortable going to work in the skyscrapers on Mainhattan?</p><p></p><p></p><p>"We had traders in London talking to brokers in the World Trade Center," he finishes. "Live, after the planes had hit. Nobody knew what was happening, but they were screaming over the phones. We're dying! We're dying!"</p><p></p><p></p><p>"The economy is beginning to grow at a normal rate again," says Niels Bünemann of the ECB, indicating that the financial world has recovered. "Connections to September 11 are getting more and more obscure. We're too far removed from it now to know what's a consequence of September 11, and what would have happened anyway."</p><p></p><p></p><p>CNN is still showing on the screens of J.P.Morgan's trading floor in Frankfurt, and the business news supports the theories of recovery. But on the personal switchboards of Sebastian and his colleagues, a button is now dedicated to transferring all calls to their cell phones in case they have to evacuate. It's a precaution, one of many small signs in the offices of global finance that there are people who still have problems sleeping at night.</p><p></p><p></p><p><strong>You may also want to read:</strong></p><p></p><p></p><ul><li><strong><a title="What the hell happened?" href="http://christian.nordtomme.com/what-the-hell-happened-3/">What the hell happened?</a>&nbsp;</strong></li></ul><p></p></div><footer class="wrapper post__footer"><p class="post__last-updated">This article was updated on September 12, 2023</p><ul class="post__tag"><li><a href="https://christian.nordtomme.com/tags/english/">In English</a></li><li><a href="https://christian.nordtomme.com/tags/journalism/">Journalism</a></li><li><a href="https://christian.nordtomme.com/tags/writing/">Writing</a></li></ul><div class="post__share"><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fchristian.nordtomme.com%2Fwhen-money-gets-frightened%2F" class="js-share facebook" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://christian.nordtomme.com/assets/svg/svg-map.svg#facebook"/></svg> <span>Facebook</span> </a><a href="https://twitter.com/share?url=https%3A%2F%2Fchristian.nordtomme.com%2Fwhen-money-gets-frightened%2F&amp;via=%40nordtomme&amp;text=When%20Money%20Gets%20Frightened" class="js-share twitter" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://christian.nordtomme.com/assets/svg/svg-map.svg#twitter"/></svg> <span>Twitter</span></a></div><div class="post__bio bio"><div><h3 class="bio__name"><a href="https://christian.nordtomme.com/authors/chris-k-n/" rel="author">Chris K. N.</a></h3></div></div></footer></article><nav class="post__nav"><div class="post__nav-inner"><div class="post__nav-next"><a href="https://christian.nordtomme.com/what-the-hell-happened/" class="post__nav-link" rel="next"><span>Next</span> What the hell happened? </a><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://christian.nordtomme.com/assets/svg/svg-map.svg#arrow-next"/></svg></div></div></nav></main><footer class="footer"><div class="footer__copyright"><p>© Copyright 2001–2023 Christian K. Nordtomme</p></div><button onclick="backToTopFunction()" id="backToTop" class="footer__bttop" aria-label="Back to top" title="Back to top"><svg><use xlink:href="https://christian.nordtomme.com/assets/svg/svg-map.svg#toparrow"/></svg></button></footer></div><script defer="defer" src="https://christian.nordtomme.com/assets/js/scripts.min.js?v=f47c11534595205f20935f0db2a62a85"></script><script>window.publiiThemeMenuConfig={mobileMenuMode:'sidebar',animationSpeed:300,submenuWidth: 'auto',doubleClickTime:500,mobileMenuExpandableSubmenus:true,relatedContainerForOverlayMenuSelector:'.top'};</script><script>var images = document.querySelectorAll('img[loading]');
        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><div class="pcb" data-behaviour="badge" data-behaviour-link="#cookie-settings" data-revision="1" data-config-ttl="90" data-debug-mode="false"><div role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-title" aria-describedby="pcb-txt" class="pcb__banner"><div class="pcb__inner"><div id="pcb-title" role="heading" aria-level="2" class="pcb__title">This website uses cookies</div><div id="pcb-txt" class="pcb__txt">Select which cookies to opt-in to via the checkboxes below; our website uses cookies to examine site traffic and user activity while on our site, for marketing, and to provide social media functionality.</div><div class="pcb__buttons"><button type="button" class="pcb__btn pcb__btn--link pcb__btn--configure" aria-haspopup="dialog">Manage preferences</button> <button type="button" class="pcb__btn pcb__btn--reject">Reject</button> <button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button></div></div></div><div class="pcb__popup" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-popup-title"><div class="pcb__popup__wrapper"><div class="pcb__inner pcb__popup__inner"><div class="pcb__popup__heading"><div id="pcb-popup-title" role="heading" aria-level="2" class="pcb__title">Cookie settings</div><button class="pcb__popup__close" aria-label="Close"></button></div><div class="pcb__popup__content"><div class="pcb__txt pcb__popup__txt">We use cookies to enhance your browsing experience, serve personalized ads or content, and analyze our traffic. By clicking "Accept All", you consent to our use of cookies.</div><ul class="pcb__groups"><li class="pcb__group"><details><summary class="pcb__group__title no-desc">Required</summary></details><div class="pcb__popup__switch is-checked"><input type="checkbox" data-group-name="" id="pcb-group-0" checked="checked"> <label for="pcb-group-0">Required</label></div></li><li class="pcb__group"><details><summary class="pcb__group__title no-desc">Analytics</summary></details><div class="pcb__popup__switch is-checked"><input type="checkbox" data-group-name="" id="pcb-group-1" checked="checked"> <label for="pcb-group-1">Analytics</label></div></li></ul></div><div class="pcb__buttons pcb__popup__buttons"><button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button> <button type="button" class="pcb__btn pcb__btn--reject">Reject all</button> <button type="button" class="pcb__btn pcb__btn--save">Save settings</button></div></div></div></div><div class="pcb__overlay" aria-hidden="true"></div><button class="pcb__badge" aria-label="Cookie Policy" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" width="40" height="40" viewBox="0 0 23 23" fill="currentColor"><path d="M21.41 12.71c-.08-.01-.15 0-.22 0h-.03c-.03 0-.05 0-.08.01-.07 0-.13.01-.19.04-.52.21-1.44.19-2.02-.22-.44-.31-.65-.83-.62-1.53a.758.758 0 0 0-.27-.61.73.73 0 0 0-.65-.14c-1.98.51-3.49.23-4.26-.78-.82-1.08-.73-2.89.24-4.49.14-.23.14-.52 0-.75a.756.756 0 0 0-.67-.36c-.64.03-1.11-.1-1.31-.35-.19-.26-.13-.71-.01-1.29.04-.18.06-.38.03-.59-.05-.4-.4-.7-.81-.66C5.1 1.54 1 6.04 1 11.48 1 17.28 5.75 22 11.6 22c5.02 0 9.39-3.54 10.39-8.42.08-.4-.18-.78-.58-.87Zm-9.81 7.82c-5.03 0-9.12-4.06-9.12-9.06 0-4.34 3.05-8 7.25-8.86-.08.7.05 1.33.42 1.81.24.32.66.67 1.38.84-.76 1.86-.65 3.78.36 5.11.61.81 2.03 2 4.95 1.51.18.96.71 1.54 1.18 1.87.62.43 1.38.62 2.1.62.05 0 .09 0 .13-.01-1.23 3.64-4.7 6.18-8.64 6.18ZM13 17c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1Zm5.29-12.3a.99.99 0 0 1-.29-.71c0-.55.45-.99 1-.99a1 1 0 0 1 .71.3c.19.19.29.44.29.71 0 .55-.45.99-1 .99a1 1 0 0 1-.71-.3ZM9 13.5c0 .83-.67 1.5-1.5 1.5S6 14.33 6 13.5 6.67 12 7.5 12s1.5.67 1.5 1.5Zm3.25.81a.744.744 0 0 1-.06-1.05c.28-.32.75-.34 1.05-.06.31.28.33.75.05 1.06-.15.16-.35.25-.56.25-.18 0-.36-.06-.5-.19ZM8.68 7.26c.41.37.44 1 .07 1.41-.2.22-.47.33-.75.33a.96.96 0 0 1-.67-.26c-.41-.37-.44-1-.07-1.41.37-.42 1-.45 1.41-.08Zm11.48 1.88c.18-.19.52-.19.7 0 .05.04.09.1.11.16.03.06.04.12.04.19 0 .13-.05.26-.15.35-.09.1-.22.15-.35.15s-.26-.05-.35-.15a.355.355 0 0 1-.11-.16.433.433 0 0 1-.04-.19c0-.13.05-.26.15-.35Zm-4.93-1.86a.75.75 0 1 1 1.059-1.06.75.75 0 0 1-1.059 1.06Z"/></svg></button></div><script>(function(win) {
    if (!document.querySelector('.pcb')) {
        return;
    }

    var cbConfig = {
        behaviour: document.querySelector('.pcb').getAttribute('data-behaviour'),
        behaviourLink: document.querySelector('.pcb').getAttribute('data-behaviour-link'),
        revision: document.querySelector('.pcb').getAttribute('data-revision'),
        configTTL: parseInt(document.querySelector('.pcb').getAttribute('data-config-ttl'), 10),
        debugMode: document.querySelector('.pcb').getAttribute('data-debug-mode') === 'true',
        initialState: null,
        previouslyAccepted: []
    };

    var cbUI = {
        wrapper: document.querySelector('.pcb'),
        banner: {
            element: null,
            btnAccept: null,
            btnReject: null,
            btnConfigure: null
        },
        popup: {
            element: null,
            btnClose: null,
            btnSave: null,
            btnAccept: null,
            btnReject: null,
            checkboxes: null,
        },
        overlay: null,
        badge: null,
        blockedScripts: document.querySelectorAll('script[type^="gdpr-blocker/"]'),
        triggerLinks: cbConfig.behaviourLink ? document.querySelectorAll('a[href*="' + cbConfig.behaviourLink + '"]') : null
    };

    function initUI () {
        // setup banner elements
        cbUI.banner.element = cbUI.wrapper.querySelector('.pcb__banner');
        cbUI.banner.btnAccept = cbUI.banner.element.querySelector('.pcb__btn--accept');
        cbUI.banner.btnReject = cbUI.banner.element.querySelector('.pcb__btn--reject');
        cbUI.banner.btnConfigure = cbUI.banner.element.querySelector('.pcb__btn--configure');

        // setup popup elements
        if (cbUI.wrapper.querySelector('.pcb__popup')) {
            cbUI.popup.element = cbUI.wrapper.querySelector('.pcb__popup');
            cbUI.popup.btnClose = cbUI.wrapper.querySelector('.pcb__popup__close');
            cbUI.popup.btnSave = cbUI.popup.element.querySelector('.pcb__btn--save');
            cbUI.popup.btnAccept = cbUI.popup.element.querySelector('.pcb__btn--accept');
            cbUI.popup.btnReject = cbUI.popup.element.querySelector('.pcb__btn--reject');
            cbUI.popup.checkboxes = cbUI.popup.element.querySelector('input[type="checkbox"]');
            // setup overlay
            cbUI.overlay = cbUI.wrapper.querySelector('.pcb__overlay');
        }

        cbUI.badge = cbUI.wrapper.querySelector('.pcb__badge');

        if (cbConfig.behaviour.indexOf('link') > -1) {
            for (var i = 0; i < cbUI.triggerLinks.length; i++) {
                cbUI.triggerLinks[i].addEventListener('click', function(e) {
                    e.preventDefault();
                    showBannerOrPopup();
                });
            }
        }
    }

    function initState () {
        var lsKeyName = getConfigName();
        var currentConfig = localStorage.getItem(lsKeyName);
        var configIsFresh = checkIfConfigIsFresh();

        if (!configIsFresh || currentConfig === null) {
            if (cbConfig.debugMode) {
                console.log('🍪 Config not found, or configuration expired');
            }

            showBanner();
        } else if (typeof currentConfig === 'string') {
            if (cbConfig.debugMode) {
                console.log('🍪 Config founded');
            }

            showBadge();

            if (cbUI.popup.element) {
                var allowedGroups = currentConfig.split(',');
                var checkedCheckboxes = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');

                for (var j = 0; j < checkedCheckboxes.length; j++) {
                    var name = checkedCheckboxes[j].getAttribute('data-group-name');

                    if (name && name !== '-' && allowedGroups.indexOf(name) === -1) {
                        checkedCheckboxes[j].checked = false;
                    }
                }

                for (var i = 0; i < allowedGroups.length; i++) {
                    var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + allowedGroups[i] + '"]');

                    if (checkbox) {
                        checkbox.checked = true;
                    }

                    allowCookieGroup(allowedGroups[i]);
                }
            }
        }

        setTimeout(function () {
            cbConfig.initialState = getInitialStateOfConsents();
        }, 0);
    }

    function checkIfConfigIsFresh () {
        var lastConfigSave = localStorage.getItem('publii-gdpr-cookies-config-save-date');

        if (lastConfigSave === null) {
            return false;
        }

        lastConfigSave = parseInt(lastConfigSave, 10);

        if (lastConfigSave === 0) {
            return true;
        }

        if (+new Date() - lastConfigSave < cbConfig.configTTL * 24 * 60 * 60 * 1000) {
            return true;
        }

        return false;
    }

    function initBannerEvents () {
        cbUI.banner.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('banner');
            showBadge();
        }, false);

        if (cbUI.banner.btnReject) {
            cbUI.banner.btnReject.addEventListener('click', function (e) {
                e.preventDefault();
                rejectAllCookies();
                showBadge();
            }, false);
        }

        if (cbUI.banner.btnConfigure) {
            cbUI.banner.btnConfigure.addEventListener('click', function (e) {
                e.preventDefault();
                hideBanner();
                showAdvancedPopup();
                showBadge();
            }, false);
        }
    }

    function initPopupEvents () {
        if (!cbUI.popup.element) {
            return;
        }

        cbUI.overlay.addEventListener('click', function (e) {
            hideAdvancedPopup();
        }, false);

        cbUI.popup.element.addEventListener('click', function (e) {
            e.stopPropagation();
        }, false);

        cbUI.popup.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('popup');
        }, false);

        cbUI.popup.btnReject.addEventListener('click', function (e) {
            e.preventDefault();
            rejectAllCookies();
        }, false);

        cbUI.popup.btnSave.addEventListener('click', function (e) {
            e.preventDefault();
            saveConfiguration();
        }, false);

        cbUI.popup.btnClose.addEventListener('click', function (e) {
            e.preventDefault();
            hideAdvancedPopup();
        }, false);
    }

    function initBadgeEvents () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.addEventListener('click', function (e) {
            showBannerOrPopup();
        }, false);
    }

    initUI();
    initState();
    initBannerEvents();
    initPopupEvents();
    initBadgeEvents();

    /**
     * API
     */
    function addScript (src, inline) {
        var newScript = document.createElement('script');

        if (src) {
            newScript.setAttribute('src', src);
        }

        if (inline) {
            newScript.text = inline;
        }

        document.body.appendChild(newScript);
    }

    function allowCookieGroup (allowedGroup) {
        var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + allowedGroup + '"]');
        cbConfig.previouslyAccepted.push(allowedGroup);
    
        for (var j = 0; j < scripts.length; j++) {
            addScript(scripts[j].src, scripts[j].text);
        }

        var groupEvent = new Event('publii-cookie-banner-unblock-' + allowedGroup);
        document.body.dispatchEvent(groupEvent);
        unlockEmbeds(allowedGroup);

        if (cbConfig.debugMode) {
            console.log('🍪 Allowed group: ' + allowedGroup);
        }
    }

    function showBannerOrPopup () {
        if (cbUI.popup.element) {
            showAdvancedPopup();
        } else {
            showBanner();
        }
    }

    function showAdvancedPopup () {
        cbUI.popup.element.classList.add('is-visible');
        cbUI.overlay.classList.add('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'false');
        cbUI.overlay.setAttribute('aria-hidden', 'false');
    }

    function hideAdvancedPopup () {
        cbUI.popup.element.classList.remove('is-visible');
        cbUI.overlay.classList.remove('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'true');
        cbUI.overlay.setAttribute('aria-hidden', 'true');
    }

    function showBanner () {
        cbUI.banner.element.classList.add('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'false');
    }

    function hideBanner () {
        cbUI.banner.element.classList.remove('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'true');
    }

    function showBadge () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.classList.add('is-visible');
        cbUI.badge.setAttribute('aria-hidden', 'false');
    }

    function getConfigName () {
        var lsKeyName = 'publii-gdpr-allowed-cookies';

        if (cbConfig.revision) {
            lsKeyName = lsKeyName + '-v' + parseInt(cbConfig.revision, 10);
        }

        return lsKeyName;
    }

    function storeConfiguration (allowedGroups) {
        var lsKeyName = getConfigName();
        var dataToStore = allowedGroups.join(',');
        localStorage.setItem(lsKeyName, dataToStore);

        if (cbConfig.configTTL === 0) {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', 0);

            if (cbConfig.debugMode) {
                console.log('🍪 Store never expiring configuration');
            }
        } else {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', +new Date());
        }
    }

    function getInitialStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Initial state: ' + groups.join(', '));
        }

        return groups;
    }

    function getCurrentStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 State to save: ' + groups.join(', '));
        }

        return groups;
    }

    function getAllGroups () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        return groups;
    }

    function acceptAllCookies (source) {
        var groupsToAccept = getAllGroups();
        storeConfiguration(groupsToAccept);

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        if (cbUI.popup.element) {
            var checkboxesToCheck = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');

            for (var j = 0; j < checkboxesToCheck.length; j++) {
                checkboxesToCheck[j].checked = true;
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Accept all cookies: ', groupsToAccept.join(', '));
        }

        if (source === 'popup') {
            hideAdvancedPopup();
        } else if (source === 'banner') {
            hideBanner();
        }
    }

    function rejectAllCookies () {
        if (cbConfig.debugMode) {
            console.log('🍪 Reject all cookies');
        }

        storeConfiguration([]);
        setTimeout(function () {
            window.location.reload();
        }, 100);
    }

    function saveConfiguration () {
        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }

        if (reloadIsNeeded(groupsToAccept)) {
            setTimeout(function () {
                window.location.reload();
            }, 100);
            return;
        }

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        hideAdvancedPopup();
    }

    function reloadIsNeeded (groupsToAccept) {
        // check if user rejected consent for initial groups
        var initialGroups = cbConfig.initialState;
        var previouslyAcceptedGroups = cbConfig.previouslyAccepted;
        var groupsToCheck = initialGroups.concat(previouslyAcceptedGroups);

        for (var i = 0; i < groupsToCheck.length; i++) {
            var groupToCheck = groupsToCheck[i];

            if (groupsToAccept.indexOf(groupToCheck) === -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Reload is needed due lack of: ', groupToCheck);
                }

                return true;
            }
        }

        return false;
    }

    function unlockEmbeds (cookieGroup) {
        var iframesToUnlock = document.querySelectorAll('.pec-wrapper[data-consent-group-id="' + cookieGroup + '"]');

        for (var i = 0; i < iframesToUnlock.length; i++) {
            var iframeWrapper = iframesToUnlock[i];
            iframeWrapper.querySelector('.pec-overlay').classList.remove('is-active');
            iframeWrapper.querySelector('.pec-overlay').setAttribute('aria-hidden', 'true');
            var iframe = iframeWrapper.querySelector('iframe');
            iframe.setAttribute('src', iframe.getAttribute('data-consent-src'));
        }
    }

    win.publiiEmbedConsentGiven = function (cookieGroup) {
        // it will unlock embeds
        allowCookieGroup(cookieGroup);

        var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + cookieGroup + '"]');

        if (checkbox) {
            checkbox.checked = true;
        }

        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }
    }
})(window);</script></body></html>